{% extends "base.html" %}
{% load static %}

{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'css/etudiant.css' %}">
{% endblock extra_styles %}

{% block content %}
<style>
   /* Styles spécifiques pour le mode sombre */
    html[data-bs-theme="dark"] table {
        width: 100%;
        border-collapse: collapse;
    }

    html[data-bs-theme="dark"] th, html[data-bs-theme="dark"] td {
        padding: 8px 12px;
        text-align: left;
        border: 1px solid #444;
        color: #e0e0e0;
    }

    html[data-bs-theme="dark"] thead {
        background-color: #222;
        color: #e0e0e0;
    }

    html[data-bs-theme="dark"] tbody tr:nth-child(even) {
        background-color: #333;
    }

    html[data-bs-theme="dark"] tbody tr:hover {
        background-color: #444;
    }
</style>


<div style="display: flex; justify-content: space-between; align-items: center;">
    <!-- Formulaire pour sélectionner l'année scolaire -->
    <form method="get" style="margin: 0;">
        <label for="annee_scolaire">Choisir une année scolaire:</label>
        <select name="annee_scolaire" id="annee_scolaire" onchange="this.form.submit()">
            {% for annee in annees_scolaires %}
                <option value="{{ annee }}" {% if annee == selected_year %}selected{% endif %}>
                    {{ annee }}
                </option>
            {% endfor %}
        </select>
    </form>

    <!-- Bouton Télécharger en Excel aligné à droite -->
    <button id="telechargerExcelBtn" class="btn btn-success" style="margin-left: auto;">Télécharger en Excel</button>
</div>

<table class="table-bordered">
    <thead>
        <tr>
            <th style="color:blue;">Matricule</th>
            <th style="color:blue;">Nom</th>
            <th style="color:blue;">Classe</th>
            <th style="color:blue;">Année scolaire</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>{{ etudiant.pk }}</td> 
            <td>{{ etudiant.name }}</td> 
            <td>{{ classe_annee|default:etudiant.classe}}</td>
            <td>{{ selected_year }}</td> 
        </tr>
    </tbody>
</table>

<h3>Semestre 1</h3>
<table id="tableSemestre1" class="table-bordered">
    <thead>
        <tr>
            <th>Matière</th>
            <th>Crédit</th>
            <th>Note 1</th>
            <th>Note 2</th>
        </tr>
    </thead>
    <tbody>
        {% for matiere, notes in notes_semestre1.items %}
            <tr>
                <td>{{ matiere.name }}</td>
                <td>{{ matiere.credit }}</td>
                <td>{{ notes.0 }}</td>
                <td>{{ notes.1 }}</td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="4">Aucune matière disponible</td>
            </tr>
        {% endfor %}
    </tbody>
</table>

<h3>Semestre 2</h3>
<table id="tableSemestre2" class="table-bordered">
    <thead>
        <tr>
            <th>Matière</th>
            <th>Crédit</th>
            <th>Note 1</th>
            <th>Note 2</th>
        </tr>
    </thead>
    <tbody>
        {% for matiere, notes in notes_semestre2.items %}
            <tr>
                <td>{{ matiere.name }}</td>
                <td>{{ matiere.credit }}</td>
                <td>{{ notes.0 }}</td>
                <td>{{ notes.1 }}</td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="4">Aucune matière disponible</td>
            </tr>
        {% endfor %}
    </tbody>
</table>


<!-- Inclure la bibliothèque SheetJS pour générer des fichiers Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
document.getElementById('telechargerExcelBtn').addEventListener('click', function () {
    // Créer un tableau pour contenir les données combinées des deux semestres
    var data = [];

    // Extraire les informations du premier tableau (étudiant)
    var nomEtudiant = document.querySelector('table tbody tr td:nth-child(2)').innerText.trim();
    var classeEtudiant = document.querySelector('table tbody tr td:nth-child(3)').innerText.trim();
    var anneeScolaire = document.querySelector('table tbody tr td:nth-child(4)').innerText.trim();

    // Ajouter l'en-tête pour Semestre 1 et Semestre 2 côte à côte
    data.push(['Matière S1', 'Crédit S1', 'Note 1 S1', 'Note 2 S1', '', 'Matière S2', 'Crédit S2', 'Note 1 S2', 'Note 2 S2']);
    
    // Fonction pour extraire les données de deux tableaux simultanément
    function extractTableDataSideBySide(tableId1, tableId2) {
        var table1 = document.getElementById(tableId1);
        var table2 = document.getElementById(tableId2);
        
        var rows1 = table1.querySelectorAll('tbody tr');
        var rows2 = table2.querySelectorAll('tbody tr');

        var maxRows = Math.max(rows1.length, rows2.length);  // Obtenir le plus grand nombre de lignes

        for (var i = 0; i < maxRows; i++) {
            var rowData = [];

            // Remplir les données du tableau Semestre 1
            if (rows1[i]) {
                var cols1 = rows1[i].querySelectorAll('td');
                cols1.forEach(function (col) {
                    rowData.push(col.innerText.trim());
                });
            } else {
                rowData.push('', '', '', '');  // Lignes vides si le Semestre 1 a moins de lignes
            }

            // Ajout d'une colonne vide pour espacer les deux semestres
            rowData.push('');

            // Remplir les données du tableau Semestre 2
            if (rows2[i]) {
                var cols2 = rows2[i].querySelectorAll('td');
                cols2.forEach(function (col) {
                    rowData.push(col.innerText.trim());
                });
            } else {
                rowData.push('', '', '', '');  // Lignes vides si le Semestre 2 a moins de lignes
            }

            data.push(rowData);  // Ajouter la ligne complète au tableau de données
        }
    }

    // Extraire les données des deux tableaux en les joignant côte à côte
    extractTableDataSideBySide('tableSemestre1', 'tableSemestre2');

    // Créer un nouveau classeur Excel
    var wb = XLSX.utils.book_new();

    // Créer une nouvelle feuille de calcul avec les données extraites
    var ws = XLSX.utils.aoa_to_sheet(data);

    // Ajouter la feuille de calcul au classeur
    XLSX.utils.book_append_sheet(wb, ws, "Notes");

    // Générer et télécharger le fichier Excel avec le nom dynamique
    var fileName = nomEtudiant + "_" + classeEtudiant + "_" + anneeScolaire + ".xlsx";
    XLSX.writeFile(wb, fileName);
});
</script>


{% endblock content %}
