{% extends "base2.html" %}
{% load static %}

{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'css/etudiant.css' %}">
{% endblock extra_styles %}

{% block content %}
<style>
    /* Styles spécifiques pour le mode sombre */
    html[data-bs-theme="dark"] table {
        width: 100%;
        border-collapse: collapse;
    }

    html[data-bs-theme="dark"] th, html[data-bs-theme="dark"] td {
        padding: 8px 12px;
        text-align: left;
        border: 1px solid #444;
        color: #e0e0e0;
    }

    html[data-bs-theme="dark"] thead {
        background-color: #222;
        color: #e0e0e0;
    }

    html[data-bs-theme="dark"] tbody tr:nth-child(even) {
        background-color: #333;
    }

    html[data-bs-theme="dark"] tbody tr:hover {
        background-color: #444;
    }
</style>

<div style="display: flex; justify-content: space-between; align-items: center;">
    <!-- Menu déroulant pour sélectionner l'année académique -->
    <form method="get">
        <label for="annee_scolaire">Choisir une année scolaire:</label>
        <select name="annee_scolaire" id="annee_scolaire" onchange="this.form.submit()">
            {% for annee in annees_scolaires %}
                <option value="{{ annee }}" {% if annee == selected_year %}selected{% endif %}>
                    {{ annee }}
                </option>
            {% endfor %}
        </select>
    </form>

    <!-- Bouton pour télécharger les informations en Excel -->
    <button id="telechargerExcelBtn"  class="btn btn-success btn-sm" style="margin-bottom:7px;">Télécharger en Excel</button>
</div>




<table class="table-bordered">
    <thead>
        <tr>
            <th style="color:blue;">Matricule</th>
            <th style="color:blue;">Nom</th>
            <th style="color:blue;">Classe</th>
            <th style="color:blue;">Année scolaire</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>{{ etudiant.pk }}</td>
            <td>{{ etudiant.name }}</td>
            <td>{{ classe_annee|default:etudiant.classe }}</td>
            <td>{{ selected_year }}</td>
        </tr>
    </tbody>
</table>

<h3>Semestre 1</h3>
<table id="tableSemestre1" class="table-bordered">
    <thead>
        <tr>
            <th>Matière</th>
            <th>Crédit</th>
            <th>Note 1</th>
            <th>Note 2</th>
        </tr>
    </thead>
    <tbody>
        {% for matiere, notes in notes_semestre1.items %}
            <tr>
                <td>{{ matiere.name }}</td>
                <td>{{ matiere.credit }}</td>
                <td>{{ notes.0 }}</td>
                <td>{{ notes.1 }}</td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="4">Aucune matière disponible</td>
            </tr>
        {% endfor %}
    </tbody>
</table>

<h3>Semestre 2</h3>
<table id="tableSemestre2" class="table-bordered">
    <thead>
        <tr>
            <th>Matière</th>
            <th>Crédit</th>
            <th>Note 1</th>
            <th>Note 2</th>
        </tr>
    </thead>
    <tbody>
        {% for matiere, notes in notes_semestre2.items %}
            <tr>
                <td>{{ matiere.name }}</td>
                <td>{{ matiere.credit }}</td>
                <td>{{ notes.0 }}</td>
                <td>{{ notes.1 }}</td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="4">Aucune matière disponible</td>
            </tr>
        {% endfor %}
    </tbody>
</table>


<!-- Inclure la bibliothèque SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
document.getElementById('telechargerExcelBtn').addEventListener('click', function () {
    // Créer un tableau de données pour le fichier Excel
    var data = [];

    // Extraire les informations de Nom, Classe, et Année scolaire depuis le premier tableau
    var nom = document.querySelector('table tbody tr td:nth-child(2)').innerText.trim();  // 2ème colonne : Nom
    var classe = document.querySelector('table tbody tr td:nth-child(3)').innerText.trim();  // 3ème colonne : Classe
    var annee = document.querySelector('table tbody tr td:nth-child(4)').innerText.trim();  // 4ème colonne : Année scolaire

    // En-têtes Semestre 1
    var headersSem1 = ['Matière Semestre 1', 'Crédit Semestre 1', 'Note 1 Semestre 1', 'Note 2 Semestre 1'];
    // Colonnes vides pour séparer
    var emptyColumns = ['', ''];
    // En-têtes Semestre 2
    var headersSem2 = ['Matière Semestre 2', 'Crédit Semestre 2', 'Note 1 Semestre 2', 'Note 2 Semestre 2'];

    // Ajouter les en-têtes des deux semestres avec les colonnes vides entre eux
    data.push(headersSem1.concat(emptyColumns).concat(headersSem2));

    // Fonction pour extraire les données des deux tableaux et les fusionner avec une séparation de deux colonnes vides
    function extractTableData(tableId1, tableId2) {
        var rowsSem1 = document.getElementById(tableId1).querySelectorAll('tbody tr');
        var rowsSem2 = document.getElementById(tableId2).querySelectorAll('tbody tr');
        
        var maxRows = Math.max(rowsSem1.length, rowsSem2.length); // Nombre maximum de lignes

        for (var i = 0; i < maxRows; i++) {
            var rowData = [];

            // Extraire les données du Semestre 1 (ou cellules vides si la ligne n'existe pas)
            if (i < rowsSem1.length) {
                var colsSem1 = rowsSem1[i].querySelectorAll('td');
                colsSem1.forEach(function (col) {
                    rowData.push(col.innerText.trim());
                });
            } else {
                rowData.push('', '', '', ''); // Lignes vides si pas de correspondance
            }

            // Ajouter les colonnes vides pour séparer
            rowData = rowData.concat(emptyColumns);

            // Extraire les données du Semestre 2 (ou cellules vides si la ligne n'existe pas)
            if (i < rowsSem2.length) {
                var colsSem2 = rowsSem2[i].querySelectorAll('td');
                colsSem2.forEach(function (col) {
                    rowData.push(col.innerText.trim());
                });
            } else {
                rowData.push('', '', '', ''); // Lignes vides si pas de correspondance
            }

            // Ajouter les données de la ligne fusionnée dans le tableau avec les colonnes vides
            data.push(rowData);
        }
    }

    // Extraire les données des deux semestres et les combiner avec deux colonnes de séparation
    extractTableData('tableSemestre1', 'tableSemestre2');

    // Créer un nouveau classeur Excel
    var wb = XLSX.utils.book_new();
    
    // Créer une nouvelle feuille de calcul avec les données
    var ws = XLSX.utils.aoa_to_sheet(data);
    
    // Ajouter la feuille de calcul au classeur
    XLSX.utils.book_append_sheet(wb, ws, "Notes");

    // Générer le nom du fichier avec les informations récupérées (Nom, Classe, Année scolaire)
    var fileName = nom + '_' + classe + '_' + annee + '.xlsx';

    // Télécharger le fichier Excel avec le nom généré
    XLSX.writeFile(wb, fileName);
});
</script>



{% endblock content %}
